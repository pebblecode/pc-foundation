<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <BaseDir Condition="'$(BaseDir)' == ''">$(ProjectDir)\..</BaseDir>
  </PropertyGroup>
  
  <Target Name="LoadAssemblyVersion" Outputs="$(AssemblyVersion)" DependsOnTargets="LoadMajorAssemblyVersion">
    <SvnVersion LocalPath="$(BaseDir)" ToolPath="C:\Program Files\SlikSvn\bin">
      <Output TaskParameter="Revision" PropertyName="AssemblyVersionRevision" />
    </SvnVersion>
    <PropertyGroup>
      <AssemblyVersion>$(MajorAssemblyVersion).$(AssemblyVersionRevision)</AssemblyVersion>
    </PropertyGroup>
  </Target>

  <Target Name="LoadMajorAssemblyVersion" Outputs="$(MajorAssemblyVersion)">
    <Version VersionFile="$(BaseDir)\version.txt">
      <Output TaskParameter="Major" PropertyName="AssemblyVersionMajor" />
      <Output TaskParameter="Minor" PropertyName="AssemblyVersionMinor" />
      <Output TaskParameter="Build" PropertyName="AssemblyVersionBuild" />
    </Version>
    <PropertyGroup>
      <MajorAssemblyVersion>$(AssemblyVersionMajor).$(AssemblyVersionMinor).$(AssemblyVersionBuild)</MajorAssemblyVersion>
    </PropertyGroup>
  </Target>
  
  <Target Name="GenerateAssemblyVersionInfoFileCs" BeforeTargets="CoreCompile" DependsOnTargets="LoadAssemblyVersion" Condition="'$(MSBuildProjectExtension)' == '.csproj'">
    <AssemblyInfo CodeLanguage="CS"
                  OutputFile="$(BaseDir)\AssemblyVersion.cs"
                  AssemblyVersion="$(AssemblyVersion)"
                  AssemblyFileVersion="$(AssemblyVersion)" />
    <Message Text="Linking from base directory: $(BaseDir)" />
    <ItemGroup>
      <Compile Include="$(BaseDir)\AssemblyVersion.cs">
        <Link>Properties\AssemblyVersion.cs</Link>
      </Compile>
    </ItemGroup>
  </Target>
  
  <Target Name="GenerateAssemblyVersionInfoFileFs" BeforeTargets="CoreCompile" DependsOnTargets="LoadAssemblyVersion" Condition="'$(MSBuildProjectExtension)' == '.fsproj'">
    <ItemGroup>
      <Tokens Include="AssemblyVersion">
        <ReplacementValue>$(AssemblyVersion)</ReplacementValue>
      </Tokens>
    </ItemGroup>
    <TemplateFile Template="$(BaseDir)\AssemblyVersion.fs.template" OutputFilename="$(BaseDir)\AssemblyVersion.fs" Tokens="@(Tokens)" />
    <ItemGroup>
      <Compile Include="$(BaseDir)\AssemblyVersion.fs">
        <Link>Properties\AssemblyVersion.fs</Link>
      </Compile>
    </ItemGroup>
  </Target>
</Project>